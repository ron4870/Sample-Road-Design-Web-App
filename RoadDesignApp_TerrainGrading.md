# RoadDesignApp – Terrain Leveling & Grading Module  
Version 1.0 • Last updated 2025-06-17  

---

## 1  Purpose & Scope  
This module equips RoadDesignApp with professional-grade tools for modifying existing terrain to meet roadway design requirements while minimizing earth-moving costs and environmental impact. It covers:  

1. Automated cut/fill optimisation with configurable cost factors.  
2. High-resolution surface modelling (existing, design, interim).  
3. Mass-haul analysis with haul-road network definition.  
4. Interactive 2-D/3-D visualisation of grading operations, volumes and haul diagrams.  
5. Seamless feedback loop to the corridor modelling and cost-estimation services.  

International references: AASHTO *Guide for Earthwork Construction*, Austroads AGRD 08, BS 6031, and ISO 10318-1.

---

## 2  High-Level Workflow  

| # | Phase | UI Pane | Engine / Service |
|---|-------|---------|------------------|
| 1 | Import / verify existing surfaces (DEM, TIN, LiDAR) | Surfaces Manager | `terrain-service` (GDAL) |
| 2 | Specify design target (corridor + template offsets, grading limits, benches) | Map/3-D View & Property Drawer | `grading-engine` (C++→WASM) |
| 3 | Run **Optimise Cut/Fill** | Toolbar button | `grading-optimizer` (Go) |
| 4 | Review optimisation report (volumes, mass-haul, balance line) | Volume Panel | `mass-haul-service` (Python) |
| 5 | Iterate: edit grading breaklines / constraints | Map/3-D gizmos | Live diff computations (WebWorker) |
| 6 | Accept → generate design surface & export quantities | Surfaces Manager | `terrain-service` saves GeoTIFF/TIN, triggers cost estimator |

Undo/Redo captured via command stack (`AddBreaklineCmd`, `SetGradeLimitCmd`, `RunOptimiseCmd`).

---

## 3  Functional Capabilities  

### 3.1  Surface Modelling  
* **Triangulated Irregular Network (TIN)** creation from DEM + survey breaklines.  
* **Multi-resolution** pyramids (LOD0..LOD4) for rapid view change.  
* **Design surface** generated by blending: corridor template slopes, ditches, pads, user breaklines.  
* **Delta surface** tool (existing – design) with colour-mapped cut (+) and fill (–).

### 3.2  Cut/Fill Optimisation  
* Objective: minimise Σ(volume × unit cost + haul × haul-cost).  
* Handles: maximum allowable grade (longitudinal, transverse), bench width, slope limits, protected areas.  
* Options:  
  * **Balance corridor** (net cut≈fill within user tolerance).  
  * **Minimise external borrow/waste**.  
  * **Fixed target elevation** for specific pads (e.g., bridge abutment).  
* Solver: Simulated Annealing hybridised with Linear Programming for global volume balance, parallelised threads.

### 3.3  Mass-Haul Calculation  
* Generates station-based volume diagram (m³ vs station).  
* Allows definition of **borrow** and **waste** pits with capacity & cost.  
* **Haul-road network**: user-drawn polylines or automatic from alignment.  
* Calculates free-haul distance, overhaul, and fleet size suggestions.  
* Outputs CSV and plotly interactive charts; exports to Primavera XER activity list.

### 3.4  Grading Design Tools  
* **Breakline editor**: add, delete, move vertices, assign target elevation or slope (%).  
* **Bench & slope wizard**: auto-create stepped slopes with user rule (e.g., 3 m @ 2:1 every 6 m elevation).  
* **Platform/pad tool**: rectangular or arbitrary polygon with flat or single-slope grade.  
* **Erosion control slope limits**: visual overlay where slopes exceed max allowed.  
* Snapping aids to corridor edge, templates, drainage ditches.

### 3.5  Visualisation  
* 2-D plan heat-map (MapLibre raster layer) with cut/fill colours, adjustable legend.  
* 3-D WebGL surface with real-time morph slider (existing ↔ design).  
* Volume glyphs: semi-transparent prisms at sample stations proportional to volume.  
* Haul arrows animated along haul-road network coloured by direction.

---

## 4  Data Model Extensions  

```
grading_job(id PK, project_id FK, status {pending,active,done,error}, options_json, created_at)
design_surface(id PK, project_id FK, grading_job_id FK, lod0_key, tin_key, mesh_res)
mass_haul(id PK, project_id FK, grading_job_id FK, csv_key, json_chart)
haul_road(id PK, project_id FK, name, path_geom LINESTRINGZ, free_haul_m)
borrow_pit(id PK, project_id FK, name, capacity_m3, cost_rate, geom POLYGONZ)
waste_area(id PK, project_id FK, name, capacity_m3, cost_rate, geom POLYGONZ)
```

Large rasters and TINs stored in MinIO under `surfaces/{project}/design_{id}.cog.tif` and `tin_{id}.dxf`.

---

## 5  Computational Services  

| Service | Lang | Key Algorithms |
|---------|------|----------------|
| `grading-engine` | C++ (WASM/native) | Surface generation, delta mesh, slope calc |
| `grading-optimizer` | Go | Simulated Annealing + LP cut/fill optimisation |
| `mass-haul-service` | Python (pandas/matplotlib) | Mass-haul curve, haul plan, fleet sizing |
| `hauling-sim` (future) | Rust + GPU | Time-sequenced haul truck simulation |

All long-running tasks emit progress over `/ws/job/{id}`.

---

## 6  User Interface Specification  

### 6.1  Side-Bar “Grading” Tab  
* **Surfaces** accordion – list & toggle existing, interim, design surfaces.  
* **Tools** sub-panel: Breakline ✏️ | Bench 🪜 | Pad ▭ | Haul-Road ➰ | Borrow/Waste ⛏️.  
* Action buttons: **Optimise**, **Compute Mass-Haul**, **Export Volumes**.

### 6.2  Property Drawer  
When selecting a breakline or pad:
```
Type.......... Breakline
Target........ Elevation 215.40 m
Slope Left.... 2:1
Slope Right... 3:1
Bench Width... 3.0 m [Auto]
```

### 6.3  Volume Panel  
* Table: Station | Cut (m³) | Fill (m³) | Net | Cumulative.  
* Chart tabs: Volume vs Station, Mass-Haul, Haul Cost vs Option sets.  
* Download 👉 CSV, PDF, XER.

### 6.4  Validation & Alerts  
| Severity | Example |
|----------|---------|
| Error ❌ | Over-excavation beyond property boundary |
| Warning ⚠️ | Unbalanced cut/fill (>5 %) |
| Info ℹ️ | Slope steeper than 2:1 requires erosion control |

---

## 7  API End-Points (NestJS)  

| Method | Path | Description |
|--------|------|-------------|
| POST | `/grading/run` | submit optimisation `{surfaceId, options}` |
| GET | `/grading/:jobId/status` | progress & result links |
| GET | `/grading/:surfaceId/tin` | stream design TIN (.dxf / .obj / gltf) |
| POST | `/masshaul` | compute mass-haul `{surfaceId, borrow[], waste[]}` |
| GET | `/masshaul/:id/csv` | download mass-haul CSV |

JWT role `designer` required to run optimisation; `viewer` may download.

---

## 8  Validation Rule Library (excerpt)  

| Rule-ID | Description | Default |
|---------|-------------|---------|
| `Grade.MaxLong` | Longitudinal grade ≤ 5 % in station range | 5 % |
| `Slope.MaxCut` | Max cut slope 1:1 in rock, 1.5:1 soil | region-specific |
| `Slope.MaxFill` | Max fill slope 2:1 unless reinforced | region-specific |
| `Bench.Interval` | Bench every 6 m vertical for slopes > 20 m high | AASHTO |
| `Boundary.Clear` | Grading stays ≥ 2 m inside ROW boundary | project param |

Rules stored YAML; can be overridden at project level.

---

## 9  Cost Integration  
* Volumes (cut, fill, borrow, waste) exported to `cost_estimator` with material codes:  
  * CUT → `EXCAVATE`  
  * FILL → `FILL`  
  * BORROW → `BORROW_IMPORT` (user-defined rate)  
  * WASTE HAUL → `WASTE_EXPORT`  

Cost estimator adds haul distance × haul rate to embankment cost line.

---

## 10  Performance & Scalability  
* WASM grading engine triangulates 2 M-point surfaces < 2 s on desktop; server-side native binary for XXL jobs.  
* Optimiser parallel-threads across CPUs; 5 km corridor with 50 k triangles converges in ≈ 30 s.  
* Delta heat-map served as COG → MapLibre picks tiles on demand (< 1 MB per zoom request).

---

## 11  Roadmap  

| Phase | Feature |
|-------|---------|
| v1.0 | Core grading, optimisation, mass-haul, visualisation |
| v1.1 | Reinforced slopes & retaining walls integration |
| v1.2 | Mass-haul schedule optimiser with equipment library |
| v2.0 | Machine-control export (Trimble GCS900, Topcon 3D-MC) |
| v2.1 | AI-driven grading hints based on historical job data |

---

**End of Terrain Leveling & Grading Specification**
